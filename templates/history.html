{% extends "base.html" %}

{% block title %}Historique - Prospector{% endblock %}

{% block extra_css %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
    }
    
    .stat-card.success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .stat-card.danger {
        background: linear-gradient(135deg, #eb3941 0%, #f15e64 100%);
    }
    
    .stat-card.info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .stat-card h3 {
        font-size: 14px;
        margin: 0 0 10px 0;
        opacity: 0.9;
        font-weight: 500;
    }
    
    .stat-card .value {
        font-size: 32px;
        font-weight: bold;
        margin: 0;
    }
    
    .stat-card .subtitle {
        font-size: 12px;
        margin-top: 5px;
        opacity: 0.8;
    }
    
    .bounce-row {
        background-color: #ffebee !important;
    }
    
    .bounce-indicator {
        color: #e74c3c;
        font-weight: bold;
        font-size: 11px;
        display: block;
        margin-top: 3px;
    }
    
    /* Styles des onglets */
    .tabs-container {
        margin-bottom: 20px;
    }
    
    .tabs {
        display: flex;
        gap: 5px;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 0;
    }
    
    .tab-btn {
        padding: 12px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #7f8c8d;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s ease;
    }
    
    .tab-btn:hover {
        color: #3498db;
        background-color: #f8f9fa;
    }
    
    .tab-btn.active {
        color: #3498db;
        border-bottom-color: #3498db;
    }
    
    .tab-btn .count {
        background-color: #e0e0e0;
        color: #555;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        margin-left: 8px;
    }
    
    .tab-btn.active .count {
        background-color: #3498db;
        color: white;
    }
    
    .tab-btn.danger .count {
        background-color: #ffcdd2;
        color: #c62828;
    }
    
    .tab-btn.danger.active {
        color: #e74c3c;
        border-bottom-color: #e74c3c;
    }
    
    .tab-btn.danger.active .count {
        background-color: #e74c3c;
        color: white;
    }
    
    .tab-btn.success .count {
        background-color: #c8e6c9;
        color: #2e7d32;
    }
    
    .tab-btn.success.active {
        color: #27ae60;
        border-bottom-color: #27ae60;
    }
    
    .tab-btn.success.active .count {
        background-color: #27ae60;
        color: white;
    }
    
    .email-row {
        display: table-row;
    }
    
    .email-row.hidden {
        display: none;
    }
    
    /* Styles pour le filtre de date */
    .date-filter-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .date-filter-label {
        font-weight: 500;
        color: #555;
    }
    
    .date-filter-buttons {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }
    
    .date-filter-btn {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
    }
    
    .date-filter-btn:hover {
        background: #f8f9fa;
        border-color: #3498db;
    }
    
    .date-filter-btn.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }
    
    .date-picker-container {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .date-picker-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 13px;
    }
    
    .date-picker-input:focus {
        outline: none;
        border-color: #3498db;
    }
    
    .btn-apply-date {
        padding: 8px 16px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
    }
    
    .btn-apply-date:hover {
        background: #2980b9;
    }
</style>
{% endblock %}

{% block content %}
<!-- Statistiques globales -->
{% if stats %}
<div class="stats-grid">
    <div class="stat-card">
        <h3>üìß Emails envoy√©s</h3>
        <div class="value">{{ stats.total_sent }}</div>
    </div>
    
    <div class="stat-card success">
        <h3>üì≠ Taux d'ouverture</h3>
        <div class="value">{{ stats.open_rate }}%</div>
        <div class="subtitle">{{ stats.total_opened }} / {{ stats.total_sent }} ouverts</div>
    </div>
    
    <div class="stat-card info">
        <h3>üí¨ Taux de r√©ponse</h3>
        <div class="value">{{ stats.reply_rate }}%</div>
        <div class="subtitle">{{ stats.total_replied }} r√©ponses</div>
    </div>
    
    <div class="stat-card danger">
        <h3>‚ùå Taux de bounce</h3>
        <div class="value">{{ stats.bounce_rate }}%</div>
        <div class="subtitle">{{ stats.total_bounced }} bounces</div>
    </div>
</div>
{% endif %}

<div class="card">
    <h2 style="margin-bottom: 20px;">‚úÖ Emails envoy√©s</h2>
    
    <!-- Filtre par date -->
    <div class="date-filter-container">
        <span class="date-filter-label">üìÖ P√©riode :</span>
        <div class="date-filter-buttons">
            <a href="{{ url_for('history.history_list') }}" class="date-filter-btn {{ 'active' if date_filter == 'all' else '' }}">Tous</a>
            <a href="{{ url_for('history.history_list', date='today') }}" class="date-filter-btn {{ 'active' if date_filter == 'today' else '' }}">Aujourd'hui</a>
            <a href="{{ url_for('history.history_list', date='yesterday') }}" class="date-filter-btn {{ 'active' if date_filter == 'yesterday' else '' }}">Hier</a>
            <a href="{{ url_for('history.history_list', date='week') }}" class="date-filter-btn {{ 'active' if date_filter == 'week' else '' }}">7 derniers jours</a>
            <a href="{{ url_for('history.history_list', date='month') }}" class="date-filter-btn {{ 'active' if date_filter == 'month' else '' }}">30 derniers jours</a>
        </div>
        <div class="date-picker-container">
            <input type="date" id="customDatePicker" class="date-picker-input" value="{{ custom_date }}">
            <button type="button" class="btn-apply-date" onclick="applyCustomDate()">Voir</button>
        </div>
    </div>
    
    <!-- Onglets de filtrage -->
    <div class="tabs-container">
        <div class="tabs">
            <button class="tab-btn active" data-filter="all" onclick="filterEmails('all', this)">
                üìß All <span class="count" id="count-all">{{ sent_drafts|length }}</span>
            </button>
            <button class="tab-btn success" data-filter="replied" onclick="filterEmails('replied', this)">
                üí¨ Replied <span class="count" id="count-replied">0</span>
            </button>
            <button class="tab-btn" data-filter="read" onclick="filterEmails('read', this)">
                üëÅÔ∏è Read <span class="count" id="count-read">0</span>
            </button>
            <button class="tab-btn" data-filter="unread" onclick="filterEmails('unread', this)">
                üì≠ Unread <span class="count" id="count-unread">0</span>
            </button>
            <button class="tab-btn danger" data-filter="bounced" onclick="filterEmails('bounced', this)">
                ‚ùå Bounced <span class="count" id="count-bounced">0</span>
            </button>
        </div>
    </div>
    
    {% if sent_drafts %}
        <table>
            <thead>
                <tr>
                    <th>Date d'envoi</th>
                    <th>Destinataire</th>
                    <th>Sujet</th>
                    <th>üì≠ Ouvert</th>
                    <th>üí¨ R√©ponse</th>
                    <th>üîÑ Relances</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for draft in sent_drafts %}
                <tr class="email-row {% if draft.has_bounce %}bounce-row{% endif %}" 
                    data-bounced="{{ 'true' if draft.has_bounce else 'false' }}"
                    data-replied="{{ 'true' if draft.has_reply else 'false' }}"
                    data-read="{{ 'true' if draft.open_count and draft.open_count > 0 else 'false' }}">
                    <td>
                        {% if draft.sent_at %}
                            {{ draft.sent_at.strftime('%d/%m/%Y %H:%M') if draft.sent_at is not string else draft.sent_at }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {{ draft.to }}
                        {% if draft.has_bounce %}
                            <span class="bounce-indicator">‚ö†Ô∏è BOUNCE</span>
                        {% endif %}
                    </td>
                    <td>{{ draft.subject }}</td>
                    <td>
                        {% if draft.open_count and draft.open_count > 0 %}
                            <span style="color: #27ae60; font-weight: bold;">
                                ‚úì {{ draft.open_count }}x
                            </span>
                            {% if draft.first_opened_at %}
                                <br><small style="color: #7f8c8d;">{{ draft.first_opened_at.strftime('%d/%m %H:%M') if draft.first_opened_at is not string else draft.first_opened_at }}</small>
                            {% endif %}
                        {% else %}
                            <span style="color: #95a5a6;">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if draft.has_bounce %}
                            <span style="color: #e74c3c; font-weight: bold;">‚ùå Bounce</span>
                        {% elif draft.has_reply %}
                            <span style="color: #27ae60; font-weight: bold;">‚úì Oui</span>
                            {% if draft.reply_received_at %}
                                <br><small style="color: #7f8c8d;">{{ draft.reply_received_at.strftime('%d/%m %H:%M') if draft.reply_received_at is not string else draft.reply_received_at }}</small>
                            {% endif %}
                        {% else %}
                            <span style="color: #95a5a6;">Non</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if draft.total_followups and draft.total_followups > 0 %}
                            <div style="font-size: 12px;">
                                {% if draft.sent_followups and draft.sent_followups > 0 %}
                                    <span style="color: #27ae60;">‚úì {{ draft.sent_followups }} envoy√©e(s)</span><br>
                                {% endif %}
                                {% if draft.scheduled_followups and draft.scheduled_followups > 0 %}
                                    <span style="color: #f39c12;">‚è± {{ draft.scheduled_followups }} planifi√©e(s)</span><br>
                                {% endif %}
                                {% if draft.cancelled_followups and draft.cancelled_followups > 0 %}
                                    <span style="color: #95a5a6;">‚úó {{ draft.cancelled_followups }} annul√©e(s)</span>
                                {% endif %}
                            </div>
                        {% else %}
                            <span style="color: #95a5a6;">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('history.sent_draft_detail', draft_id=draft.id) }}" class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">üëÅÔ∏è D√©tails</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="empty-state">
            <p>Aucun email envoy√© pour le moment</p>
        </div>
    {% endif %}
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">‚ùå Drafts rejet√©s</h2>
        {% if rejected_drafts %}
        <form method="POST" action="{{ url_for('api.delete_rejected') }}" onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer tous les drafts rejet√©s ? Cette action est irr√©versible.');">
            <button type="submit" class="btn btn-danger" style="font-size: 12px;">
                üóëÔ∏è Supprimer tous ({{ rejected_drafts|length }})
            </button>
        </form>
        {% endif %}
    </div>
    
    {% if rejected_drafts %}
        <table>
            <thead>
                <tr>
                    <th>Date de rejet</th>
                    <th>Date de cr√©ation</th>
                    <th>Destinataire</th>
                    <th>Sujet</th>
                </tr>
            </thead>
            <tbody>
                {% for draft in rejected_drafts %}
                <tr>
                    <td>
                        {% if draft.rejected_at %}
                            {{ draft.rejected_at.strftime('%d/%m/%Y %H:%M') if draft.rejected_at is not string else draft.rejected_at }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if draft.created_at %}
                            {{ draft.created_at.strftime('%d/%m/%Y %H:%M') if draft.created_at is not string else draft.created_at }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ draft.to }}</td>
                    <td>{{ draft.subject }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="empty-state">
            <p>Aucun draft rejet√© pour le moment</p>
        </div>
    {% endif %}
</div>

<div style="margin-top: 20px;">
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary">‚Üê Retour aux drafts en attente</a>
</div>

<script>
// Compter et initialiser les onglets
document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('.email-row');
    let countBounced = 0, countReplied = 0, countRead = 0, countUnread = 0;
    
    rows.forEach(row => {
        const isBounced = row.dataset.bounced === 'true';
        const isReplied = row.dataset.replied === 'true';
        const isRead = row.dataset.read === 'true';
        
        if (isBounced) countBounced++;
        if (isReplied) countReplied++;
        if (isRead && !isBounced) countRead++;
        if (!isRead && !isBounced) countUnread++;
    });
    
    document.getElementById('count-bounced').textContent = countBounced;
    document.getElementById('count-replied').textContent = countReplied;
    document.getElementById('count-read').textContent = countRead;
    document.getElementById('count-unread').textContent = countUnread;
});

function filterEmails(filter, btn) {
    // Mettre √† jour les onglets actifs
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    // Filtrer les lignes
    const rows = document.querySelectorAll('.email-row');
    
    rows.forEach(row => {
        const isBounced = row.dataset.bounced === 'true';
        const isReplied = row.dataset.replied === 'true';
        const isRead = row.dataset.read === 'true';
        
        let show = false;
        
        switch(filter) {
            case 'all':
                show = true;
                break;
            case 'bounced':
                show = isBounced;
                break;
            case 'replied':
                show = isReplied;
                break;
            case 'read':
                show = isRead && !isBounced;
                break;
            case 'unread':
                show = !isRead && !isBounced;
                break;
        }
        
        row.classList.toggle('hidden', !show);
    });
}
</script>
{% endblock %}
